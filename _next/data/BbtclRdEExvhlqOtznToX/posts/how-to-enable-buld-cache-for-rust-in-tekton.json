{"pageProps":{"post":{"title":"TektonでRustのコンテナビルドする際のmount=type=cacheを有効にする","date":"2022-12-29T00:00:00.000Z","tags":["rust"],"draft":false,"summary":"TektonでRustのDockerfileのビルドを高速化する方法","slug":"how-to-enable-buld-cache-for-rust-in-tekton","locale":"ja","body":{"raw":"\n<TOCInline toc={props.toc} asDisclosure />\n<br />\n\n# Summary\n\n- Tekton で Rust のコンテナをビルドしたい\n  - Tekton は CI/CD ツールで、趣味用の Kubernetes クラスタで運用している\n- Rust のコンテナビルドの高速化方法は様々あるが、個人的には mount=type=cache をつけてキャッシュしてしまうのが楽\n- Tekton でコンテナビルドする方法はいくつかあるが、mount=type=cache に対応しているもので簡単に利用できたのは buildah だった\n  - buildah\n    - https://hub.tekton.dev/tekton/task/buildah\n  - kaniko は非対応\n    - https://hub.tekton.dev/tekton/task/kaniko\n    - https://github.com/GoogleContainerTools/kaniko/issues/969\n  - buildkit はセットアップするもうまく動かなかった（詳細は未検証）\n    - https://hub.tekton.dev/tekton/task/buildkit\n- しかし、Tekton Hub にある Task そのままではキャッシュを有効にできないため変更が必要\n  - キャッシュするディレクトリの PVC をつくり、mount してやる\n\n# Task buildah.yaml の変更\n\n以下のように、オリジナルの Task を変更した\n\nbuildah.yaml\n\n```yaml\napiVersion: tekton.dev/v1beta1\nkind: Task\nmetadata:\n  name: buildah\n  ...\nspec:\n  ...\n  steps:\n  - name: build\n    image: $(params.BUILDER_IMAGE)\n    workingDir: $(workspaces.source.path)\n    script: |\n      [[ \"$(workspaces.sslcertdir.bound)\" == \"true\" ]] && CERT_DIR_FLAG=\"--cert-dir $(workspaces.sslcertdir.path)\"\n      [[ \"$(workspaces.dockerconfig.bound)\" == \"true\" ]] && export DOCKER_CONFIG=\"$(workspaces.dockerconfig.path)\"\n      buildah ${CERT_DIR_FLAG} --storage-driver=$(params.STORAGE_DRIVER) bud \\\n        $(params.BUILD_EXTRA_ARGS) --format=$(params.FORMAT) \\\n        --tls-verify=$(params.TLSVERIFY) --layers \\\n        -f $(params.DOCKERFILE) -t $(params.IMAGE) $(params.CONTEXT)\n      ...\n    volumeMounts:\n    - name: varlibcontainers\n      mountPath: /var/lib/containers\n    - name: buildah-cache\n      mountPath: /var/tmp/buildah-cache\n    securityContext:\n      privileged: true\n  volumes:\n  - name: varlibcontainers\n    persistentVolumeClaim:\n      claimName: build-cache\n  - name: buildah-cache\n    persistentVolumeClaim:\n      claimName: build-mount-cache\n```\n\nbuild-cache.yaml\n\n```yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: build-cache\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 10Gi\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: build-mount-cache\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 10Gi\n```\n\n変更後に`kubectl apply -f`して反映。\n\n変更点は、\n\n- `buildah bud`の引数の`--no-cache`を`--layers`にして、レイヤーのキャッシュを有効にする\n  - https://github.com/tektoncd/catalog/issues/265\n  - もともと emptyDir()で--layers をつけていて、Tekton の run 間でキャッシュが有効でない →--no-cache にした経緯がある\n- `--layers`のキャッシュを永続化するための PVC を追加 (build-cache)\n- `mount=type=cache`のキャッシュを永続化するための PVC を追加(build-mount-cache)\n  - 保存先のパスは実装を見た\n  - https://github.com/flouthoc/buildah/blob/e6eb05f757fe6faa72196eb6f0a3fef91d036cc6/internal/parse/parse.go\n\n# まとめ\n\n- Tekton で Rust の Docker ビルドを高速化するために、キャッシュを有効にする方法を説明した\n- ストレージがフルになったときの対応などしないといけなそうだが、趣味環境なのでそのときに考える\n","code":"var Component=(()=>{var h=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var N=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports),y=(a,e)=>{for(var s in e)l(a,s,{get:e[s],enumerable:!0})},t=(a,e,s,i)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let c of u(e))!k.call(a,c)&&c!==s&&l(a,c,{get:()=>e[c],enumerable:!(i=p(e,c))||i.enumerable});return a};var b=(a,e,s)=>(s=a!=null?h(m(a)):{},t(e||!a||!a.__esModule?l(s,\"default\",{value:a,enumerable:!0}):s,a)),g=a=>t(l({},\"__esModule\",{value:!0}),a);var o=N((x,r)=>{r.exports=_jsx_runtime});var v={};y(v,{default:()=>C,frontmatter:()=>f});var n=b(o()),f={title:\"Tekton\\u3067Rust\\u306E\\u30B3\\u30F3\\u30C6\\u30CA\\u30D3\\u30EB\\u30C9\\u3059\\u308B\\u969B\\u306Emount=type=cache\\u3092\\u6709\\u52B9\\u306B\\u3059\\u308B\",date:new Date(1672272e6),slug:\"how-to-enable-buld-cache-for-rust-in-tekton\",draft:!1,tags:[\"rust\"],summary:\"Tekton\\u3067Rust\\u306EDockerfile\\u306E\\u30D3\\u30EB\\u30C9\\u3092\\u9AD8\\u901F\\u5316\\u3059\\u308B\\u65B9\\u6CD5\"};function d(a){let e=Object.assign({h1:\"h1\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",p:\"p\",pre:\"pre\",code:\"code\"},a.components),{TOCInline:s}=e;return s||R(\"TOCInline\",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s,{toc:a.toc,asDisclosure:!0}),(0,n.jsx)(\"br\",{}),(0,n.jsxs)(e.h1,{id:\"summary\",children:[(0,n.jsx)(e.a,{href:\"#summary\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Summary\"]}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"Tekton \\u3067 Rust \\u306E\\u30B3\\u30F3\\u30C6\\u30CA\\u3092\\u30D3\\u30EB\\u30C9\\u3057\\u305F\\u3044\",(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:\"Tekton \\u306F CI/CD \\u30C4\\u30FC\\u30EB\\u3067\\u3001\\u8DA3\\u5473\\u7528\\u306E Kubernetes \\u30AF\\u30E9\\u30B9\\u30BF\\u3067\\u904B\\u7528\\u3057\\u3066\\u3044\\u308B\"})})]}),(0,n.jsx)(e.li,{children:\"Rust \\u306E\\u30B3\\u30F3\\u30C6\\u30CA\\u30D3\\u30EB\\u30C9\\u306E\\u9AD8\\u901F\\u5316\\u65B9\\u6CD5\\u306F\\u69D8\\u3005\\u3042\\u308B\\u304C\\u3001\\u500B\\u4EBA\\u7684\\u306B\\u306F mount=type=cache \\u3092\\u3064\\u3051\\u3066\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3057\\u3066\\u3057\\u307E\\u3046\\u306E\\u304C\\u697D\"}),(0,n.jsxs)(e.li,{children:[\"Tekton \\u3067\\u30B3\\u30F3\\u30C6\\u30CA\\u30D3\\u30EB\\u30C9\\u3059\\u308B\\u65B9\\u6CD5\\u306F\\u3044\\u304F\\u3064\\u304B\\u3042\\u308B\\u304C\\u3001mount=type=cache \\u306B\\u5BFE\\u5FDC\\u3057\\u3066\\u3044\\u308B\\u3082\\u306E\\u3067\\u7C21\\u5358\\u306B\\u5229\\u7528\\u3067\\u304D\\u305F\\u306E\\u306F buildah \\u3060\\u3063\\u305F\",(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"buildah\",(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://hub.tekton.dev/tekton/task/buildah\",children:\"https://hub.tekton.dev/tekton/task/buildah\"})})})]}),(0,n.jsxs)(e.li,{children:[\"kaniko \\u306F\\u975E\\u5BFE\\u5FDC\",(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://hub.tekton.dev/tekton/task/kaniko\",children:\"https://hub.tekton.dev/tekton/task/kaniko\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://github.com/GoogleContainerTools/kaniko/issues/969\",children:\"https://github.com/GoogleContainerTools/kaniko/issues/969\"})})]})]}),(0,n.jsxs)(e.li,{children:[\"buildkit \\u306F\\u30BB\\u30C3\\u30C8\\u30A2\\u30C3\\u30D7\\u3059\\u308B\\u3082\\u3046\\u307E\\u304F\\u52D5\\u304B\\u306A\\u304B\\u3063\\u305F\\uFF08\\u8A73\\u7D30\\u306F\\u672A\\u691C\\u8A3C\\uFF09\",(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://hub.tekton.dev/tekton/task/buildkit\",children:\"https://hub.tekton.dev/tekton/task/buildkit\"})})})]})]})]}),(0,n.jsxs)(e.li,{children:[\"\\u3057\\u304B\\u3057\\u3001Tekton Hub \\u306B\\u3042\\u308B Task \\u305D\\u306E\\u307E\\u307E\\u3067\\u306F\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3092\\u6709\\u52B9\\u306B\\u3067\\u304D\\u306A\\u3044\\u305F\\u3081\\u5909\\u66F4\\u304C\\u5FC5\\u8981\",(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:\"\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3059\\u308B\\u30C7\\u30A3\\u30EC\\u30AF\\u30C8\\u30EA\\u306E PVC \\u3092\\u3064\\u304F\\u308A\\u3001mount \\u3057\\u3066\\u3084\\u308B\"})})]})]}),(0,n.jsxs)(e.h1,{id:\"task-buildahyaml-\\u306E\\u5909\\u66F4\",children:[(0,n.jsx)(e.a,{href:\"#task-buildahyaml-\\u306E\\u5909\\u66F4\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Task buildah.yaml \\u306E\\u5909\\u66F4\"]}),(0,n.jsx)(e.p,{children:\"\\u4EE5\\u4E0B\\u306E\\u3088\\u3046\\u306B\\u3001\\u30AA\\u30EA\\u30B8\\u30CA\\u30EB\\u306E Task \\u3092\\u5909\\u66F4\\u3057\\u305F\"}),(0,n.jsx)(e.p,{children:\"buildah.yaml\"}),(0,n.jsx)(e.pre,{className:\"language-yaml\",children:(0,n.jsxs)(e.code,{className:\"language-yaml code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` tekton.dev/v1beta1\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"kind\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` Task\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"metadata\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` buildah\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"...\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"spec\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"...\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"steps\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` build\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"image\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` $(params.BUILDER_IMAGE)\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"workingDir\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` $(workspaces.source.path)\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"script\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"|\"}),(0,n.jsx)(e.span,{className:\"token scalar string\",children:`\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token scalar string\",children:`      [[ \"$(workspaces.sslcertdir.bound)\" == \"true\" ]] && CERT_DIR_FLAG=\"--cert-dir $(workspaces.sslcertdir.path)\"\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token scalar string\",children:`      [[ \"$(workspaces.dockerconfig.bound)\" == \"true\" ]] && export DOCKER_CONFIG=\"$(workspaces.dockerconfig.path)\"\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token scalar string\",children:\"      buildah ${CERT_DIR_FLAG} --storage-driver=$(params.STORAGE_DRIVER) bud \\\\\\n\"})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token scalar string\",children:`        $(params.BUILD_EXTRA_ARGS) --format=$(params.FORMAT) \\\\\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token scalar string\",children:`        --tls-verify=$(params.TLSVERIFY) --layers \\\\\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token scalar string\",children:`        -f $(params.DOCKERFILE) -t $(params.IMAGE) $(params.CONTEXT)\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token scalar string\",children:\"      ...\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"volumeMounts\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` varlibcontainers\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"mountPath\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` /var/lib/containers\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" buildah\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"mountPath\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" /var/tmp/buildah\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"securityContext\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"privileged\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"volumes\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` varlibcontainers\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"persistentVolumeClaim\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"claimName\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" build\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" buildah\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"persistentVolumeClaim\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"claimName\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" build\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\"mount\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]})]})}),(0,n.jsx)(e.p,{children:\"build-cache.yaml\"}),(0,n.jsx)(e.pre,{className:\"language-yaml\",children:(0,n.jsxs)(e.code,{className:\"language-yaml code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` v1\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"kind\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` PersistentVolumeClaim\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"metadata\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" build\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"spec\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"accessModes\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),` ReadWriteOnce\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"resources\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"requests\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"storage\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` 10Gi\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"---\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"apiVersion\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` v1\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"kind\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` PersistentVolumeClaim\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"metadata\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" build\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\"mount\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`cache\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"spec\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"accessModes\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),` ReadWriteOnce\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"resources\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"requests\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token atrule key\",children:\"storage\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` 10Gi\n`]})]})}),(0,n.jsxs)(e.p,{children:[\"\\u5909\\u66F4\\u5F8C\\u306B\",(0,n.jsx)(e.code,{children:\"kubectl apply -f\"}),\"\\u3057\\u3066\\u53CD\\u6620\\u3002\"]}),(0,n.jsx)(e.p,{children:\"\\u5909\\u66F4\\u70B9\\u306F\\u3001\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"buildah bud\"}),\"\\u306E\\u5F15\\u6570\\u306E\",(0,n.jsx)(e.code,{children:\"--no-cache\"}),\"\\u3092\",(0,n.jsx)(e.code,{children:\"--layers\"}),\"\\u306B\\u3057\\u3066\\u3001\\u30EC\\u30A4\\u30E4\\u30FC\\u306E\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3092\\u6709\\u52B9\\u306B\\u3059\\u308B\",(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://github.com/tektoncd/catalog/issues/265\",children:\"https://github.com/tektoncd/catalog/issues/265\"})}),(0,n.jsx)(e.li,{children:\"\\u3082\\u3068\\u3082\\u3068 emptyDir()\\u3067--layers \\u3092\\u3064\\u3051\\u3066\\u3044\\u3066\\u3001Tekton \\u306E run \\u9593\\u3067\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u304C\\u6709\\u52B9\\u3067\\u306A\\u3044 \\u2192--no-cache \\u306B\\u3057\\u305F\\u7D4C\\u7DEF\\u304C\\u3042\\u308B\"})]})]}),(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"--layers\"}),\"\\u306E\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3092\\u6C38\\u7D9A\\u5316\\u3059\\u308B\\u305F\\u3081\\u306E PVC \\u3092\\u8FFD\\u52A0 (build-cache)\"]}),(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"mount=type=cache\"}),\"\\u306E\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3092\\u6C38\\u7D9A\\u5316\\u3059\\u308B\\u305F\\u3081\\u306E PVC \\u3092\\u8FFD\\u52A0(build-mount-cache)\",(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:\"\\u4FDD\\u5B58\\u5148\\u306E\\u30D1\\u30B9\\u306F\\u5B9F\\u88C5\\u3092\\u898B\\u305F\"}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://github.com/flouthoc/buildah/blob/e6eb05f757fe6faa72196eb6f0a3fef91d036cc6/internal/parse/parse.go\",children:\"https://github.com/flouthoc/buildah/blob/e6eb05f757fe6faa72196eb6f0a3fef91d036cc6/internal/parse/parse.go\"})})]})]})]}),(0,n.jsxs)(e.h1,{id:\"\\u307E\\u3068\\u3081\",children:[(0,n.jsx)(e.a,{href:\"#\\u307E\\u3068\\u3081\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"\\u307E\\u3068\\u3081\"]}),(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:\"Tekton \\u3067 Rust \\u306E Docker \\u30D3\\u30EB\\u30C9\\u3092\\u9AD8\\u901F\\u5316\\u3059\\u308B\\u305F\\u3081\\u306B\\u3001\\u30AD\\u30E3\\u30C3\\u30B7\\u30E5\\u3092\\u6709\\u52B9\\u306B\\u3059\\u308B\\u65B9\\u6CD5\\u3092\\u8AAC\\u660E\\u3057\\u305F\"}),(0,n.jsx)(e.li,{children:\"\\u30B9\\u30C8\\u30EC\\u30FC\\u30B8\\u304C\\u30D5\\u30EB\\u306B\\u306A\\u3063\\u305F\\u3068\\u304D\\u306E\\u5BFE\\u5FDC\\u306A\\u3069\\u3057\\u306A\\u3044\\u3068\\u3044\\u3051\\u306A\\u305D\\u3046\\u3060\\u304C\\u3001\\u8DA3\\u5473\\u74B0\\u5883\\u306A\\u306E\\u3067\\u305D\\u306E\\u3068\\u304D\\u306B\\u8003\\u3048\\u308B\"})]})]})}function T(a={}){let{wrapper:e}=a.components||{};return e?(0,n.jsx)(e,Object.assign({},a,{children:(0,n.jsx)(d,a)})):d(a)}var C=T;function R(a,e){throw new Error(\"Expected \"+(e?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return g(v);})();\n;return Component;"},"_id":"posts/202212/how-to-enable-buld-cache-for-rust-in-tekton/index.mdx","_raw":{"sourceFilePath":"posts/202212/how-to-enable-buld-cache-for-rust-in-tekton/index.mdx","sourceFileName":"index.mdx","sourceFileDir":"posts/202212/how-to-enable-buld-cache-for-rust-in-tekton","contentType":"mdx","flattenedPath":"posts/202212/how-to-enable-buld-cache-for-rust-in-tekton"},"type":"Blog","readingTime":{"text":"3 min read","minutes":2.605,"time":156300,"words":521},"path":"posts/how-to-enable-buld-cache-for-rust-in-tekton","filePath":"posts/202212/how-to-enable-buld-cache-for-rust-in-tekton/index.mdx","toc":[{"value":"Summary","url":"#summary","depth":1},{"value":"Task buildah.yaml の変更","url":"#task-buildahyaml-の変更","depth":1},{"value":"まとめ","url":"#まとめ","depth":1}]},"authorDetails":[{"name":"Tomohiro Kato / @tkat0","avatar":"/static/images/tkat0.jpg","occupation":"Softweare Engineer / Double Bassist","twitter":"https://twitter.com/_tkato_","linkedin":"https://www.linkedin.com/in/tkat0/","github":"https://github.com/tkat0","slug":"default","locale":"en","type":"Authors","readingTime":{"text":"3 min read","minutes":2.33,"time":139800,"words":466},"path":"posts/default","filePath":"authors/default.en.mdx","toc":[{"value":"2021-","url":"#2021-","depth":3},{"value":"2018-2020","url":"#2018-2020","depth":3},{"value":"2014-2017","url":"#2014-2017","depth":3},{"value":"Publications","url":"#publications","depth":3},{"value":"2022","url":"#2022","depth":4},{"value":"2021","url":"#2021","depth":4},{"value":"2020","url":"#2020","depth":4},{"value":"2019","url":"#2019","depth":4},{"value":"2018","url":"#2018","depth":4}],"tags":[]}],"prev":{"title":"How to create a React app with Rust and WebAssembly","date":"2022-01-06T00:00:00.000Z","tags":["wasm","rust"],"draft":false,"summary":"In this article, I'll introduce followings through creating simple demo application.","slug":"how-to-create-a-react-app-with-rust-and-wasm","locale":"ja","type":"Blog","readingTime":{"text":"6 min read","minutes":5.25,"time":315000,"words":1050},"path":"posts/how-to-create-a-react-app-with-rust-and-wasm","filePath":"posts/202201/how-to-create-a-react-app-with-rust-and-wasm/index.mdx","toc":[{"value":"Summary","url":"#summary","depth":2},{"value":"What is WebAssembly?","url":"#what-is-webassembly","depth":2},{"value":"Create a React App with create-react-app","url":"#create-a-react-app-with-create-react-app","depth":2},{"value":"Create Rust library for Wasm","url":"#create-rust-library-for-wasm","depth":2},{"value":"Create Rust library with cargo.","url":"#create-rust-library-with-cargo","depth":3},{"value":"Implement a Rust function that you want to call from JavaScript.","url":"#implement-a-rust-function-that-you-want-to-call-from-javascript","depth":3},{"value":"Wrap the function with wasm-bindgen to export it as Wasm.","url":"#wrap-the-function-with-wasm-bindgen-to-export-it-as-wasm","depth":3},{"value":"Build as Wasm library with wasm-pack","url":"#build-as-wasm-library-with-wasm-pack","depth":3},{"value":"Call the Wasm function from the React app.","url":"#call-the-wasm-function-from-the-react-app","depth":3},{"value":"Advanced topics","url":"#advanced-topics","depth":2},{"value":"Conclusion","url":"#conclusion","depth":2}]},"next":{"title":"2022年の振り返り","date":"2022-12-29T09:00:00.000Z","tags":["yearly-review","translated"],"draft":false,"summary":"2022年の振り返り。","slug":"2022-review","locale":"ja","type":"Blog","readingTime":{"text":"5 min read","minutes":4.91,"time":294600,"words":982},"path":"posts/2022-review","filePath":"posts/202212/2022-review.mdx","toc":[{"value":"プロダクト開発に関わっていました","url":"#プロダクト開発に関わっていました","depth":1},{"value":"使える技術が増えました","url":"#使える技術が増えました","depth":1},{"value":"キャリアを振り返って","url":"#キャリアを振り返って","depth":1},{"value":"まとめ","url":"#まとめ","depth":1}]}},"__N_SSG":true}