{"pageProps":{"post":{"title":"PyTorchのModule#named_modules","date":"2019-02-05T23:30:00.000Z","tags":["pytorch","deeplearning"],"summary":"PyTorchのModule#named_modulesでモデル内のすべてのOperatorにアクセスするときにはまったメモ。","slug":"pytorch-named_modules","locale":"en","body":{"raw":"\nPyTorch の Module#named_modules でモデル内のすべての Operator にアクセスするときにはまったメモ。\n\nPyTorch は Chainer でいう Link も Function も Module なのでグラフのトレースは楽かと思ったけど意外とはまった。 model.named_modules()では nn.Sequential もその中身の Module もすべてが得られてしまうので、 Module#modules でコンテナ内のモジュール数をチェックした上でトレースしていくことで、nn.Conv2d などプリミティブな OP のみ得られる。\n\n以下がコード例\n\n```python\nfor name, module in model.named_modules():\n    # nn.Sequentialやユーザー定義の複数のmoduleをもつmoduleではなく、\n    # Conv2dなどの単一のmoduleのみ取得\n    n_modules = len(list(module.modules()))\n    if n_modules == 1:\n        print(name)\n```\n\nModule のドキュメントを読むと良かった。\n\ntorch.nn — PyTorch master documentation\nhttps://pytorch.org/docs/stable/nn.html#module\n\nPyTorch の内部構造については以下のような記事があるようだ。\n\nhttps://twitter.com/_tkato_/status/1092762049602441216\nhttps://twitter.com/_tkato_/status/1092761728956264448\n","code":"var Component=(()=>{var m=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var N=(a,n)=>()=>(n||a((n={exports:{}}).exports,n),n.exports),_=(a,n)=>{for(var t in n)c(a,t,{get:n[t],enumerable:!0})},l=(a,n,t,o)=>{if(n&&typeof n==\"object\"||typeof n==\"function\")for(let s of u(n))!k.call(a,s)&&s!==t&&c(a,s,{get:()=>n[s],enumerable:!(o=p(n,s))||o.enumerable});return a};var y=(a,n,t)=>(t=a!=null?m(h(a)):{},l(n||!a||!a.__esModule?c(t,\"default\",{value:a,enumerable:!0}):t,a)),g=a=>l(c({},\"__esModule\",{value:!0}),a);var d=N((j,r)=>{r.exports=_jsx_runtime});var x={};_(x,{default:()=>M,frontmatter:()=>f});var e=y(d()),f={title:\"PyTorch\\u306EModule#named_modules\",date:new Date(15494094e5),slug:\"pytorch-named_modules\",tags:[\"pytorch\",\"deeplearning\"],summary:\"PyTorch\\u306EModule#named_modules\\u3067\\u30E2\\u30C7\\u30EB\\u5185\\u306E\\u3059\\u3079\\u3066\\u306EOperator\\u306B\\u30A2\\u30AF\\u30BB\\u30B9\\u3059\\u308B\\u3068\\u304D\\u306B\\u306F\\u307E\\u3063\\u305F\\u30E1\\u30E2\\u3002\"};function i(a){let n=Object.assign({p:\"p\",pre:\"pre\",code:\"code\",span:\"span\",a:\"a\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"PyTorch \\u306E Module#named_modules \\u3067\\u30E2\\u30C7\\u30EB\\u5185\\u306E\\u3059\\u3079\\u3066\\u306E Operator \\u306B\\u30A2\\u30AF\\u30BB\\u30B9\\u3059\\u308B\\u3068\\u304D\\u306B\\u306F\\u307E\\u3063\\u305F\\u30E1\\u30E2\\u3002\"}),(0,e.jsx)(n.p,{children:\"PyTorch \\u306F Chainer \\u3067\\u3044\\u3046 Link \\u3082 Function \\u3082 Module \\u306A\\u306E\\u3067\\u30B0\\u30E9\\u30D5\\u306E\\u30C8\\u30EC\\u30FC\\u30B9\\u306F\\u697D\\u304B\\u3068\\u601D\\u3063\\u305F\\u3051\\u3069\\u610F\\u5916\\u3068\\u306F\\u307E\\u3063\\u305F\\u3002 model.named_modules()\\u3067\\u306F nn.Sequential \\u3082\\u305D\\u306E\\u4E2D\\u8EAB\\u306E Module \\u3082\\u3059\\u3079\\u3066\\u304C\\u5F97\\u3089\\u308C\\u3066\\u3057\\u307E\\u3046\\u306E\\u3067\\u3001 Module#modules \\u3067\\u30B3\\u30F3\\u30C6\\u30CA\\u5185\\u306E\\u30E2\\u30B8\\u30E5\\u30FC\\u30EB\\u6570\\u3092\\u30C1\\u30A7\\u30C3\\u30AF\\u3057\\u305F\\u4E0A\\u3067\\u30C8\\u30EC\\u30FC\\u30B9\\u3057\\u3066\\u3044\\u304F\\u3053\\u3068\\u3067\\u3001nn.Conv2d \\u306A\\u3069\\u30D7\\u30EA\\u30DF\\u30C6\\u30A3\\u30D6\\u306A OP \\u306E\\u307F\\u5F97\\u3089\\u308C\\u308B\\u3002\"}),(0,e.jsx)(n.p,{children:\"\\u4EE5\\u4E0B\\u304C\\u30B3\\u30FC\\u30C9\\u4F8B\"}),(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" name\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" module \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" model\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"named_modules\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# nn.Sequential\\u3084\\u30E6\\u30FC\\u30B6\\u30FC\\u5B9A\\u7FA9\\u306E\\u8907\\u6570\\u306Emodule\\u3092\\u3082\\u3064module\\u3067\\u306F\\u306A\\u304F\\u3001\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Conv2d\\u306A\\u3069\\u306E\\u5358\\u4E00\\u306Emodule\\u306E\\u307F\\u53D6\\u5F97\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    n_modules \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"len\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"list\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"module\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"modules\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" n_modules \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"print\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"name\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Module \\u306E\\u30C9\\u30AD\\u30E5\\u30E1\\u30F3\\u30C8\\u3092\\u8AAD\\u3080\\u3068\\u826F\\u304B\\u3063\\u305F\\u3002\"}),(0,e.jsxs)(n.p,{children:[\"torch.nn \\u2014 PyTorch master documentation \",(0,e.jsx)(n.a,{href:\"https://pytorch.org/docs/stable/nn.html#module\",children:\"https://pytorch.org/docs/stable/nn.html#module\"})]}),(0,e.jsx)(n.p,{children:\"PyTorch \\u306E\\u5185\\u90E8\\u69CB\\u9020\\u306B\\u3064\\u3044\\u3066\\u306F\\u4EE5\\u4E0B\\u306E\\u3088\\u3046\\u306A\\u8A18\\u4E8B\\u304C\\u3042\\u308B\\u3088\\u3046\\u3060\\u3002\"}),(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.a,{href:\"https://twitter.com/_tkato_/status/1092762049602441216\",children:\"https://twitter.com/_tkato_/status/1092762049602441216\"}),\" \",(0,e.jsx)(n.a,{href:\"https://twitter.com/_tkato_/status/1092761728956264448\",children:\"https://twitter.com/_tkato_/status/1092761728956264448\"})]})]})}function w(a={}){let{wrapper:n}=a.components||{};return n?(0,e.jsx)(n,Object.assign({},a,{children:(0,e.jsx)(i,a)})):i(a)}var M=w;return g(x);})();\n;return Component;"},"_id":"posts/201902/pytorch-named_modules.mdx","_raw":{"sourceFilePath":"posts/201902/pytorch-named_modules.mdx","sourceFileName":"pytorch-named_modules.mdx","sourceFileDir":"posts/201902","contentType":"mdx","flattenedPath":"posts/201902/pytorch-named_modules"},"type":"Blog","readingTime":{"text":"2 min read","minutes":1.05,"time":63000,"words":210},"path":"posts/pytorch-named_modules","filePath":"posts/201902/pytorch-named_modules.mdx","toc":[]},"authorDetails":[{"name":"Tomohiro Kato / @tkat0","avatar":"/static/images/tkat0.jpg","occupation":"Softweare Engineer / Double Bassist","twitter":"https://twitter.com/_tkato_","linkedin":"https://www.linkedin.com/in/tkat0/","github":"https://github.com/tkat0","slug":"default","locale":"en","type":"Authors","readingTime":{"text":"3 min read","minutes":2.33,"time":139800,"words":466},"path":"posts/default","filePath":"authors/default.en.mdx","toc":[{"value":"2021-","url":"#2021-","depth":3},{"value":"2018-2020","url":"#2018-2020","depth":3},{"value":"2014-2017","url":"#2014-2017","depth":3},{"value":"Publications","url":"#publications","depth":3},{"value":"2022","url":"#2022","depth":4},{"value":"2021","url":"#2021","depth":4},{"value":"2020","url":"#2020","depth":4},{"value":"2019","url":"#2019","depth":4},{"value":"2018","url":"#2018","depth":4}],"tags":[]}],"prev":{"title":"Chainer-compiler調査（1）","date":"2019-02-04T00:30:00.000Z","tags":["chainer-compiler","deeplearning","chainer"],"summary":"今日からChainer-compilerについて調べてみよう。","slug":"learn-chainer-compiler-1","locale":"en","type":"Blog","readingTime":{"text":"6 min read","minutes":5.59,"time":335400,"words":1118},"path":"posts/learn-chainer-compiler-1","filePath":"posts/201902/learn-chainer-compiler-1.mdx","toc":[{"value":"Examples","url":"#examples","depth":2},{"value":"Overview of components","url":"#overview-of-components","depth":2},{"value":"chainer-compiler/python","url":"#chainer-compilerpython","depth":2},{"value":"次にやりたいこと","url":"#次にやりたいこと","depth":2}]},"next":{"title":"Chainer-compiler調査（2）","date":"2019-02-06T00:30:00.000Z","tags":["chainer-compiler","deeplearning","chainer"],"summary":"Chainer-compilerの調査その2","slug":"learn-chainer-compiler-2","locale":"en","type":"Blog","readingTime":{"text":"3 min read","minutes":2.515,"time":150900,"words":503},"path":"posts/learn-chainer-compiler-2","filePath":"posts/201902/learn-chainer-compiler-2.mdx","toc":[{"value":"examples/train_mnist.py","url":"#examplestrain_mnistpy","depth":2},{"value":"CompiledModel#forward","url":"#compiledmodelforward","depth":2},{"value":"CompiledModel#compile","url":"#compiledmodelcompile","depth":2},{"value":"RunCompiledModel#forward","url":"#runcompiledmodelforward","depth":2},{"value":"その他","url":"#その他","depth":2}]}},"__N_SSG":true}